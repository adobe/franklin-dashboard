<html>
    <head>

    </head>
    <body>
        <h1>Franklin Dashboard</h1>
        <hr>

        <div id="main2" style="width:100%; height:400px;"></div>

        <script>

        async function drawChart() {
            // load chart library
            const script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = "./echarts.min.js";
            document.head.appendChild(script);
            
            // initialize chart
            const script2 = document.createElement('script');
            script2.type = 'text/javascript';
            script2.innerHTML = `
                var chartDom = document.getElementById('main2');
                var myChart = echarts.init(chartDom);
                myChart.setOption(option);
            `;
            document.head.appendChild(script2);

            //var chartDom = document.getElementById('main2');
            //var myChart = echarts.init(chartDom);

            // prepare run-query params
            var params = new URL(window.location.href).searchParams;
            var url = params.get("url");
            var domainkey = params.get("domainkey");
            var startdate = new Date();
            startdate.setDate(startdate.getDate() - 30);
            startdate = startdate.toISOString().split('T')[0];
            var enddate = new Date();
            enddate = enddate.toISOString().split('T')[0];

            var runquery =
                "https://lqmig3v5eb.execute-api.us-east-1.amazonaws.com/helix-services/run-query/ci5270/rum-pageviews-bdf"
                + "?domainkey=" + domainkey
                + "&url=" + url
                + "&interval=-1"
                + "&startdate=" + startdate
                + "&enddate=" + enddate;
            
            /*
            fetch(runquery)
                .then((response) => response.json)
                .then((results) => {
                
                })
            */
            
            const response = await fetch(runquery);
            const jsonData = await response.json();
            
            //const response = fetch(runquery);
            //const jsonData = response.json();
           
            // prepare arrays compatible with ECharts
            var dates = new Array();
            var pageviews = new Array();
            var lastdate = "";
            let i = 0;
            while (i < jsonData.results.data.length) {
                let date = jsonData.results.data[i].date;
                let pageview = jsonData.results.data[i].estimated_pv;

                // this particular run-query does not return
                // by date, but rather by date/weight combo.
                // need to sum multiple results for same date
                if (date != lastdate) {
                    dates.push(date);
                    pageviews.push(parseInt(pageview));
                } else {
                    let partialpageviews = pageviews.pop();
                    pageviews.push(partialpageviews + parseInt(pageview));
                }

                lastdate = date;
                i++;
            }

            // prepare chart
            var option = {
                title: {
                    text: 'Estimated page views for ' + url,
                    subtext: 'Last 30 days',
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                },
                xAxis: {
                    type: 'category',
                    data: dates
                },
                yAxis: {
                    type: 'value'
                },
                series: [
                    {
                    data: pageviews,
                    type: 'line',
                    smooth: true
                    }
                ]
            };
            //myChart.setOption(option);
        
        }
            
        window.setTimeout(() => drawChart(), 3000);

        //drawChart();

        </script>
    </body>
</html>
