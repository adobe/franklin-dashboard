<html>
    <head>
        <style>
            #loading img {display: block; margin: auto;}
            .hide {display: none;}
            .container-2col {display: grid; grid-template-columns: 1fr 1fr;}
            .main {height: 300px;}
            .wide {grid-column-start: 1; grid-column-end: 3;}
            .header {font-weight: bold;}
        </style>
    </head>
    <body>
        
        <div class="container-2col">
            <div class="main wide">
                <div id="loading"><img src="./loading.gif"></div>
                <div id="pageviews" style="width:100%; height:300px;"></div>
            </div>
            <div>
                <div id="top-pages" style="height:300px;"></div>
            </div>
            <div>
                <div id="another-chart"></div>
        </div>

        <script>
        var chartDom = document.getElementById('pageviews');
        var listDom = document.getElementById('top-pages');
        
        // prepare run-query params
        var params = new URL(window.location.href).searchParams;
        var url = params.get("url");
        var domainkey = params.get("domainkey");
        var startdate = new Date();
        startdate.setDate(startdate.getDate() - 30);
        startdate = startdate.toISOString().split('T')[0];
        var enddate = new Date();
        enddate = enddate.toISOString().split('T')[0];
        var limit = params.get("limit");
        if (!limit) {limit = 10};

        // prepare query URL
        var runquery =
            "https://helix-pages.anywhere.run/helix-services/run-query@ci5359/dash@pageviews"
            + "?domainkey=" + domainkey
            + "&url=" + url
            + "&interval=-1"
            + "&offset=-1"
            + "&startdate=" + startdate
            + "&enddate=" + enddate;

        var runquery2 =
            "https://helix-pages.anywhere.run/helix-services/run-query@ci5359/dash@top-pages"
            + "?domainkey=" + domainkey
            + "&url=" + url
            + "&interval=-1"
            + "&offset=-1"
            + "&startdate=" + startdate
            + "&enddate=" + enddate;

        async function drawChart() {
            // call query
            const response = await fetch(runquery);
            const jsonData = await response.json();

            // prepare arrays compatible with chart
            var dates = new Array();
            var pageviews = new Array();
   
            let i = 0;
            while (i < jsonData.results.data.length) {
                let date = jsonData.results.data[i].date;
                let pageview = jsonData.results.data[i].estimated_pv;

                dates.push(date);
                pageviews.push(parseInt(pageview));

                i++;
            }

            // prepare chart
            var option = {
                title: {
                    text: 'Estimated page views for ' + url,
                    subtext: 'Last 30 days',
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                },
                xAxis: {
                    type: 'category',
                    data: dates
                },
                yAxis: {
                    type: 'value'
                },
                series: [
                    {
                    data: pageviews,
                    type: 'line',
                    smooth: true
                    }
                ]
            };
            
            // hide loading icon
            document.getElementById("loading").classList.add("hide");
            
            var myChart = echarts.init(chartDom);
            myChart.setOption(option);
        
        }

        async function drawList() {
            // call query
            const response = await fetch(runquery2);
            const jsonData = await response.json();

            // prepare DOM for list
            let container = document.createElement("div");
            container.className = "container-2col";

            let headerTitle = document.createElement("div");
            headerTitle.classList.add("header", "wide");
            headerTitle.textContent = "Top " + limit + " most popular pages";
            container.appendChild(headerTitle);
        
            let headerUrl = document.createElement("div");
            headerUrl.className = "header";
            headerUrl.textContent = "URL";
            container.appendChild(headerUrl);

            let headerCount = document.createElement("div");
            headerCount.className = "header";
            headerCount.textContent = "Estimated Count";
            container.appendChild(headerCount);

            listDom.appendChild(container);

            // add results data
            let i = 0;
            while (i < jsonData.results.data.length && i < parseInt(limit)) {
                let page = jsonData.results.data[i].url;
                let pageview = jsonData.results.data[i].estimated_pv;
                
                let url = document.createElement("div");
                let anchor = document.createElement("a");
                anchor.setAttribute("href", "javascript:alert('draw-lcp-chart');")
                anchor.textContent = page;
                url.appendChild(anchor);
                container.appendChild(url);

                let count = document.createElement("div");
                count.textContent = pageview;
                container.appendChild(count);

                i++;
            }

        }

        //window.setTimeout(() => drawChart(), 3000);
        async function drawPage() {
            //await drawChart();
            //await drawList();
            drawChart();
            drawList();
        }
        drawPage();

        </script>
        
        <script src="./echarts.min.js"></script>
        
    </body>
</html>

